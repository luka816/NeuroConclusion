<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <title>ნეიროფსიქოლოგიური დასკვნა</title>
    <link rel="stylesheet" href="style.css">

</head>

<body data-theme="light">

    <h1>ნეიროფსიქოლოგიური დასკვნის გენერატორი</h1>

    <div class="form-buttons">
        <button class="secondary" onclick="collapseAll()">ყველას დამალვა</button>
        <button class="secondary" onclick="expandAll()">ყველას გამოჩენა</button>
        <button class="secondary" onclick="uncheckAll()">ყველას მოხსნა</button>
        <button class="primary" onclick="generateConclusion()">დასკვნის გენერაცია</button>
        <button class="secondary" onclick="toggleDarkMode()">Dark Mode</button>
    </div>


    <div id="form"></div>

    <div class="sticky-output">
        <div id="copyToast" class="copy-toast">
            ✅ დაკოპირებულია!
        </div>
        <textarea id="output" placeholder="დასკვნა აქ გამოჩნდება..."></textarea>
        <button class="primary" onclick="copyToClipboard()">კოპირება</button>
    </div>

    <script>
        fetch("templates.json")
            .then(r => r.json())
            .then(data => renderForm(data));

        function renderForm(data) {
            const form = document.getElementById("form");

            data.categories.sort((a, b) => a.order - b.order).forEach(cat => {
                const c = document.createElement("div");
                c.className = "category";

                const h2 = document.createElement("h2");
                h2.innerHTML = `<span class="arrow">▶</span>${cat.label}`;

                const content = document.createElement("div");
                content.className = "category-content";

                h2.onclick = () => {
                    const open = content.style.display === "block";
                    content.style.display = open ? "none" : "block";
                    h2.querySelector(".arrow").textContent = open ? "▶" : "▼";
                };

                cat.subcategories.sort((a, b) => a.order - b.order).forEach(sub => {
                    const s = document.createElement("div");
                    s.className = "subcategory";

                    const h3 = document.createElement("h3");
                    h3.innerHTML = `<span class="arrow">▶</span>${sub.label}`;

                    const phrases = document.createElement("div");
                    phrases.className = "phrases";

                    h3.onclick = () => {
                        const open = phrases.style.maxHeight && phrases.style.maxHeight !== "0px";
                        phrases.style.maxHeight = open ? "0px" : phrases.scrollHeight + "px";
                        h3.querySelector(".arrow").textContent = open ? "▶" : "▼";
                    };

                    sub.phrases.forEach((p, i) => {
                        const lbl = document.createElement("label");
                        const cb = document.createElement("input");
                        cb.type = "checkbox";
                        cb.dataset.text = p.text;
                        cb.dataset.order = `${cat.order}.${sub.order}.${i}`;
                        cb.onchange = updateOutput;
                        lbl.append(cb, " " + p.text);
                        phrases.appendChild(lbl);
                    });

                    s.append(h3, phrases);
                    content.appendChild(s);
                });

                c.append(h2, content);
                form.appendChild(c);
            });
        }

        function expandAll() {
            document.querySelectorAll(".category-content").forEach(c => c.style.display = "block");
            document.querySelectorAll(".phrases").forEach(p => p.style.maxHeight = p.scrollHeight + "px");
            document.querySelectorAll(".arrow").forEach(a => a.textContent = "▼");
        }

        function collapseAll() {
            document.querySelectorAll(".category-content").forEach(c => c.style.display = "none");
            document.querySelectorAll(".phrases").forEach(p => p.style.maxHeight = "0px");
            document.querySelectorAll(".arrow").forEach(a => a.textContent = "▶");
        }

        function updateOutput() {
            output.value = [...document.querySelectorAll("input:checked")]
                .sort((a, b) => a.dataset.order.localeCompare(b.dataset.order))
                .map(c => c.dataset.text).join("");
        }

        function generateConclusion() { updateOutput(); }
        function uncheckAll() { document.querySelectorAll("input").forEach(c => c.checked = false); output.value = ""; }
        function copyToClipboard() {
            navigator.clipboard.writeText(output.value).then(() => {
                const toast = document.getElementById("copyToast");
                toast.classList.add("show");

                setTimeout(() => {
                    toast.classList.remove("show");
                }, 1500);
            });
        }

        function toggleDarkMode() {
            document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
        }
    </script>

</body>

</html>